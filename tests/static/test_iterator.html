<!doctype html>
<html>
    <head>
        <title>Mocha Tests</title>
        <link rel="stylesheet" href="mocha.css">
    </head>

    <body>

        <div id="fixtures"></div>
        <div id="mocha"></div>

        <script src="jquery-1.7.1.min.js"></script>
        <script src="mocha.js"></script>
        <script src="chai.js"></script>
        <script src="sinon-1.17.6.js"></script>
        <script>mocha.setup("bdd");</script>

        <!-- load code you want to test heere -->
        <script src="../../app/static/scripts/mail.ajax.js"></script>
        <script src="../../app/static/scripts/mail.iterator.js"></script>

        <!-- load your test files here -->
        <script>

        var assert = chai.assert;

        describe("E-Mails Iterators Test", function() {

        describe("SelectIterator Test", function() {

            describe("init Test", function() {

                var stub_getEMailsCount = null;

                beforeEach(function() {
                    stub_getEMailsCount = sinon.stub(window, "getEMailsCount");
                });

                afterEach(function() {
                    stub_getEMailsCount.restore();
                });

                it("test for calling getEMailsCount", function() {
                    var iterator = new SelectIterator({
                            emailsPerPage: 10
                        });
                    iterator.init({mailbox: "INBOX"});
                    assert.isTrue(stub_getEMailsCount.calledOnce);
                });

                it("raises error when no mailbox", function() {
                    var iterator = new SelectIterator({
                            emailsPerPage: 10
                        });
                    assert.throws(function() {
                            iterator.init({mailblox: "INBOX"});
                        });
                });

            });

        }); // SelectIterator Test

        describe("SearchIterator Test", function() {

            describe("init Test", function() {

                var stub_searchEMails = null;

                beforeEach(function() {
                    stub_searchEMails = sinon.stub(window, "searchEMails");
                });

                afterEach(function() {
                    stub_searchEMails.restore();
                });

                it("test for calling searchEMails", function() {
                    var iterator = new SearchIterator({
                            emailsPerPage: 10
                        });
                    iterator.init({mailbox: "INBOX", criteria: [
                        {key: "SUBJECT", value: "Test", decode: true}]});
                    assert.isTrue(stub_searchEMails.calledOnce);
                });

                it("passes args to search function", function() {
                    var iterator = new SearchIterator({
                            emailsPerPage: 10
                        });
                    iterator.init({mailbox: "INBOX", criteria: [
                        {key: "SUBJECT", value: "Test", decode: true}]});
                    assert.equal(stub_searchEMails.getCall(0).args[0].mailbox, 
                                 "INBOX");
                    assert.equal(stub_searchEMails.getCall(0).args[0].criteria[0].key, 
                                 "SUBJECT");
                });

                it("sets callback in search function", function() {
                    var iterator = new SearchIterator({
                            emailsPerPage: 10
                        });
                    iterator.init({mailbox: "INBOX", criteria: [
                        {key: "SUBJECT", value: "Test", decode: true}]});
                    assert.isFunction(stub_searchEMails.getCall(0).args[0].callback);
                });

                it("raises error when no mailbox", function() {
                    var iterator = new SearchIterator({
                            emailsPerPage: 10
                        });
                    assert.throws(function() {
                            iterator.init({mailblox: "INBOX"});
                        });
                });

                it("raises error when no criteria", function() {
                    var iterator = new SearchIterator({
                            emailsPerPage: 10
                        });
                    assert.throws(function() {
                            iterator.init({mailbox: "INBOX"});
                        });
                });

            });         

        }); // SearchIterator Test    

        }); // E-Mails Iterators Test

        </script>

        <script>
            mocha.run();
        </script>
    </body>

</html>